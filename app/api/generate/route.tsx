import type { NextRequest, NextResponse } from "next/server";
import { createHash } from "crypto";
import { kv } from "@vercel/kv";
import { generate } from "random-words";

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const userEmail = searchParams.get("userEmail");

  if (!userEmail) {
    return new Response(null, {
      status: 302,
      headers: { Location: "/guest" },
    });
  }

  const hashEmail = createHash("sha256").update(userEmail).digest("hex");

  const randomWordArr = generate({ minLength: 6, maxLength: 6, exactly: 1 });
  const randomWord = Array.isArray(randomWordArr)
    ? randomWordArr[0]
    : randomWordArr;
  const encodedWord = encodeMessage(randomWord);

  await kv.hset(hashEmail, { currentWord: randomWord });
  await kv.hset(hashEmail, { currentEncodedWord: encodedWord });

  return new Response(JSON.stringify({ encodedWord }), {
    status: 200,
    headers: { "Content-Type": "application/json" },
  });
}

// export async function handler(req: NextRequest) {
//   return new Response(JSON.stringify({ message: "Method Not Allowed" }), {
//     status: 405,
//     headers: { "Content-Type": "application/json" },
//   });
// }

const chineseStrokes: { [key: string]: string[] } = {
  0: [
    "丞",
    "丟",
    "丠",
    "丢",
    "乑",
    "乒",
    "乓",
    "乔",
    "乨",
    "乩",
    "乫",
    "买",
    "争",
    "亘",
    "亙",
    "亚",
    "交",
    "亥",
    "亦",
    "产",
    "仮",
    "仯",
    "仰",
    "仱",
    "仲",
    "仳",
    "仴",
    "仵",
    "件",
    "价",
    "仸",
    "仹",
    "任",
    "仼",
    "份",
    "仾",
    "仿",
    "伀",
    "企",
    "伂",
    "伃",
    "伄",
    "伅",
    "伆",
    "伇",
    "伈",
    "伉",
    "伊",
    "伌",
    "伍",
    "伎",
    "伏",
    "伐",
    "休",
    "伒",
    "伓",
    "伔",
    "伕",
    "伖",
    "众",
    "优",
    "伙",
    "会",
    "伛",
    "伜",
    "伝",
    "伞",
    "伟",
    "传",
    "伡",
    "伢",
    "伣",
    "伤",
    "伥",
    "伦",
    "伧",
    "伨",
    "伩",
    "伪",
    "伫",
    "伬",
    "佤",
    "似",
    "佢",
    "充",
    "兆",
    "兇",
    "先",
    "光",
    "全",
    "共",
    "关",
    "兴",
    "再",
    "军",
    "农",
    "冰",
    "冱",
    "冲",
    "决",
    "冴",
    "凨",
    "凩",
    "凪",
    "凫",
    "凼",
    "刎",
    "刏",
    "刐",
    "刑",
    "划",
    "刓",
    "刔",
    "刕",
    "刖",
    "列",
    "刘",
    "则",
    "刚",
    "创",
    "劣",
    "劤",
    "劥",
    "劦",
    "劧",
    "动",
    "匈",
    "匟",
    "匠",
    "匡",
    "匢",
    "圾",
    "卋",
    "华",
    "协",
    "危",
    "厊",
    "压",
    "厌",
    "厍",
    "厽",
    "厾",
    "叒",
    "叿",
    "吀",
    "吁",
    "吂",
    "吃",
    "各",
    "吅",
    "吆",
    "吇",
    "合",
    "吉",
    "吊",
    "吋",
    "同",
    "名",
    "后",
    "吏",
    "吐",
    "向",
    "吒",
    "吓",
    "吔",
    "吕",
    "吖",
    "吗",
    "吸",
    "囝",
    "回",
    "囟",
    "因",
    "囡",
    "团",
    "団",
    "在",
    "圩",
    "圪",
    "圫",
    "圬",
    "圭",
    "圮",
    "圯",
    "地",
    "圱",
    "圲",
    "圳",
    "圴",
    "圵",
    "圶",
    "圷",
    "圸",
    "圹",
    "场",
    "壮",
    "夅",
    "夙",
    "多",
    "夛",
    "夵",
    "夶",
    "夷",
    "夸",
    "夹",
    "夺",
    "夻",
    "夼",
    "奸",
    "她",
    "奺",
    "奻",
    "奼",
    "好",
    "奾",
    "饿",
    "妀",
    "妁",
    "如",
    "妃",
    "妄",
    "妅",
    "妆",
    "妇",
    "妈",
    "孖",
    "字",
    "存",
    "孙",
    "宅",
    "宆",
    "宇",
    "守",
    "安",
    "寺",
    "寻",
    "导",
    "尖",
    "尗",
    "尘",
    "尥",
    "尧",
    "尽",
    "屰",
    "屸",
    "屹",
    "屺",
    "屻",
    "屼",
    "屽",
    "屾",
    "屿",
    "岀",
    "岁",
    "岂",
    "岃",
    "州",
    "巟",
    "巩",
    "帆",
    "帇",
    "师",
    "年",
    "并",
    "庄",
    "庅",
    "庆",
    "延",
    "廷",
    "异",
    "弎",
    "式",
    "弙",
    "弚",
    "弛",
    "弜",
    "当",
    "彴",
    "彵",
    "彶",
    "忈",
    "忋",
    "忏",
    "忓",
    "忔",
    "忕",
    "忖",
    "忙",
    "忚",
    "忛",
    "忣",
    "戌",
    "戍",
    "戎",
    "戏",
    "成",
    "托",
    "扙",
    "扚",
    "扛",
    "扜",
    "扝",
    "扞",
    "扠",
    "扡",
    "扢",
    "扣",
    "扤",
    "扥",
    "扦",
    "执",
    "扨",
    "扩",
    "扪",
    "扫",
    "扬",
    "扟",
    "扱",
    "收",
    "旨",
    "早",
    "旬",
    "旭",
    "旮",
    "旯",
    "毕",
    "曲",
    "曳",
    "有",
    "朱",
    "朲",
    "朳",
    "朴",
    "朵",
    "朶",
    "朷",
    "朸",
    "朹",
    "机",
    "朻",
    "朼",
    "朽",
    "朾",
    "朿",
    "杀",
    "杁",
    "杂",
    "权",
    "次",
    "欢",
    "此",
    "死",
    "毎",
    "耳",
    "自",
    "至",
    "行",
    "衣",
    "氖",
    "気",
    "氘",
    "氼",
    "汆",
    "汊",
    "汋",
    "汌",
    "汍",
    "汎",
    "汏",
    "汐",
    "汑",
    "汒",
    "汓",
    "汔",
    "汕",
    "汗",
    "汘",
    "汙",
    "汚",
    "汛",
    "汜",
    "汝",
    "江",
    "池",
    "污",
    "汢",
    "汣",
    "汤",
    "灯",
    "灰",
    "灱",
    "灲",
    "灳",
    "爷",
    "牝",
    "牞",
    "牟",
    "犱",
    "犲",
    "犳",
    "犴",
    "犵",
    "犷",
    "犸",
    "玎",
    "玏",
    "玐",
    "玑",
    "甪",
    "甶",
    "百",
    "癿",
    "礽",
    "竹",
    "米",
    "纡",
    "红",
    "纣",
    "纤",
    "纥",
    "约",
    "级",
    "纨",
    "纩",
    "纪",
    "纫",
    "缶",
    "网",
    "羽",
    "老",
    "考",
    "而",
    "聿",
    "肉",
    "肋",
    "肌",
    "肍",
    "肎",
    "芃",
    "芄",
    "芅",
    "芆",
    "芇",
    "芉",
    "芊",
    "芋",
    "芌",
    "芍",
    "芎",
    "芏",
    "芐",
    "芑",
    "芒",
    "芓",
    "芕",
    "芖",
    "芗",
    "讲",
    "讳",
    "讴",
    "讵",
    "讶",
    "讷",
    "许",
    "讹",
    "论",
    "讻",
    "讼",
    "讽",
    "设",
    "访",
    "诀",
    "邞",
    "邟",
    "邠",
    "邡",
    "邢",
    "那",
    "邤",
    "邥",
    "邦",
    "邧",
    "邨",
    "邩",
    "邪",
    "邬",
    "阥",
    "阦",
    "阧",
    "阨",
    "阩",
    "阪",
    "阫",
    "阬",
    "阭",
    "阮",
    "阯",
    "阰",
    "阱",
    "防",
    "阳",
    "阴",
    "阵",
    "阶",
    "驮",
    "驯",
    "驰",
  ],
  1: [
    "两",
    "严",
    "丽",
    "串",
    "乱",
    "亊",
    "亨",
    "亩",
    "伯",
    "估",
    "伴",
    "伶",
    "伸",
    "伺",
    "伽",
    "佃",
    "但",
    "位",
    "低",
    "住",
    "佐",
    "佑",
    "体",
    "何",
    "佗",
    "余",
    "佛",
    "作",
    "你",
    "佣",
    "佥",
    "克",
    "免",
    "兑",
    "兵",
    "况",
    "冷",
    "初",
    "删",
    "判",
    "别",
    "利",
    "助",
    "努",
    "劫",
    "励",
    "劲",
    "劳",
    "医",
    "即",
    "却",
    "卵",
    "县",
    "君",
    "吞",
    "吟",
    "否",
    "吧",
    "吨",
    "含",
    "听",
    "启",
    "吴",
    "吹",
    "吻",
    "吾",
    "呀",
    "呆",
    "呈",
    "告",
    "呐",
    "呒",
    "呓",
    "呔",
    "呕",
    "呖",
    "呗",
    "员",
    "呛",
    "呜",
    "园",
    "困",
    "围",
    "固",
    "声",
    "壳",
    "巫",
    "妊",
    "妓",
    "妖",
    "妗",
    "妙",
    "妥",
    "妨",
    "妩",
    "妪",
    "妫",
    "姊",
    "姒",
    "妍",
    "孚",
    "孛",
    "孜",
    "孝",
    "宋",
    "完",
    "宏",
    "寿",
    "尾",
    "尿",
    "局",
    "屁",
    "层",
    "希",
    "帐",
    "庇",
    "床",
    "序",
    "库",
    "应",
    "弃",
    "弄",
    "弟",
    "张",
    "形",
    "役",
    "彻",
    "忌",
    "忍",
    "志",
    "忘",
    "忧",
    "快",
    "怀",
    "怃",
    "怄",
    "怅",
    "怆",
    "我",
    "戒",
    "扭",
    "扮",
    "扰",
    "扶",
    "批",
    "找",
    "技",
    "抄",
    "把",
    "抑",
    "抒",
    "抓",
    "投",
    "抖",
    "抗",
    "折",
    "抚",
    "抛",
    "択",
    "护",
    "报",
    "改",
    "攻",
    "旱",
    "时",
    "旷",
    "角",
    "走",
    "龟",
    "男",
    "甸",
    "町",
    "疗",
    "皂",
    "社",
    "祀",
    "秀",
    "私",
    "究",
    "穷",
    "纶",
    "纬",
    "纯",
    "纱",
    "纲",
    "纳",
    "纵",
    "纷",
    "纸",
    "纹",
    "纺",
    "纽",
    "纾",
    "肐",
    "肓",
    "肖",
    "肘",
    "肚",
    "肛",
    "肝",
    "肠",
    "芙",
    "芜",
    "芦",
    "芬",
    "芭",
    "芯",
    "花",
    "芳",
    "芹",
    "芽",
    "苍",
    "苏",
    "证",
    "评",
    "识",
    "诈",
    "诉",
    "诊",
    "词",
    "译",
    "轩",
    "运",
    "近",
    "返",
    "还",
    "这",
    "进",
    "远",
    "违",
    "连",
    "迟",
    "邑",
    "邮",
    "邯",
    "邰",
    "邱",
    "邵",
    "邻",
    "针",
    "钉",
    "钊",
    "钋",
    "钌",
    "闰",
    "闲",
    "间",
    "闷",
    "阻",
    "阿",
    "附",
    "际",
    "陆",
    "陈",
    "饨",
    "饩",
    "饪",
    "饫",
    "饭",
    "饮",
    "驱",
    "驳",
    "驴",
  ],
};

const baconianDict: { [key: string]: string } = {
  a: "00000",
  b: "00001",
  c: "00010",
  d: "00011",
  e: "00100",
  f: "00101",
  g: "00110",
  h: "00111",
  i: "01000",
  j: "01000",
  k: "01001",
  l: "01010",
  m: "01011",
  n: "01100",
  o: "01101",
  p: "01110",
  q: "01111",
  r: "10000",
  s: "10001",
  t: "10010",
  u: "10011",
  v: "10011",
  w: "10100",
  x: "10101",
  y: "10110",
  z: "10111",
};
const hi = baconianDict.x;

export const encodeMessage = (message: string): string => {
  const binaryMessage = message
    .toLowerCase()
    .split("")
    .map((char: string) => baconianDict[char])
    .join("");
  const chunks = binaryMessage.match(/.{1,5}/g) || [];

  return chunks
    .map((chunk) => {
      return chunk
        .split("")
        .map((bit) => {
          const chars = chineseStrokes[bit];
          const randomIndex = Math.floor(Math.random() * chars.length);
          return chars[randomIndex];
        })
        .join("");
    })
    .join("");
};
